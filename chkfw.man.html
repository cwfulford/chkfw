<h2 id="heading1">NAME</h2>
<p class="indent">
<b>chkfw</b>
- check (and correct) running iptables firewall configurations on a remote host.
<h2 id="heading2">SYNOPSIS</h2>
<p class=indent>
<b>chkfw</b> [[<b>-C</b>] [<b>-cc </b><i><email_address></i>] [<b>-d</b>]
[<b>-l</b>]
[\fB-m\<i><#max_wait></i>]</i>
[<b>-n</b>] [<b>-p </b><i><#,#...></i>] [<b>-T</b>] [<b>-u</b>|<b>-U</b>] [<b>-v</b>]] |
<i><hostname></i>|<b>-V</b>
</p>
<h2 id="heading3">AVAILABILITY</h2>
<p class=indent>
<b>chkfw</b>
is a Bourne shell script which should work equally well on all versions of UNIX,
Linux and Mac OS X.
<h2 id="heading4">DESCRIPTION</h2>
<b>chkfw</b>
checks running firewalls against a known template on the administration
server. If the running firewall's configuration has deviated from the known
configuration,
<b>chkfw</b>
will attempt to restore the firewall to the approved configuration, provided
that the local firewall configuration and boot files are identical to those on
the administration box and that the plesk configured firewall (if any) has not
been activated.
<p>
Urgent alerts are sent by email and optionally by SMS text message 
(see <b>-T</b> option below).
<p>
Additionally ports which are expected to be open may be checked if enumerated
on the command line.
<h2 id="heading5">OPTIONS</h2>
<p class="indent">
<b>-C</b>
Check and report on status of firewall and enumerated ports only. Do not change
running configuration.
<p class="indent">
<b>-cc </b>
<i><email_address></i>
.br
Send copies of warnings and alerts to 
<i>email_address</i>
<p class="indent">
<b>-d</b>
Start in debug mode.
.IR chkfw .
A message will also be emailed to the address set as 
<i>email_rcpt</i>
with copies to
<i>email_address</i>
if set with the 
<i>-cc</i>
option.
<p class="indent">
<b>--force-restore</b>
This option should only be used with extreme caution. The firewall will be restarted
with the configuration on the remote host as found in 
<i>/etc/sysconfig/iptables</i>
and 
.IR /etc/sysconfig/iptables-config ,
even if these differ from the canonical files stored on the administration server. 
<p class="indent">
<b>-l</b>
Use the <i>syslog</i> facility to log the check and any alerts generated.
<p class="indent">
<b>-m #</b><i><maxi_wait></i>
Set the maximum time (in minutes) to wait for the 
ports to become available.
<p class="indent">
<p class="indent">
<b>-p #</b>[,<b>#</b>[,<b>#</b>]....]
Enumerated ports to be scanned with 
.BR nmap .
<p class="indent">
<b>-T</b>
When raising alerts additionally send text messages to the recipient specified with the variable 
.IR $txt .
The mechanism employed is an email to SMS gateway so 
<i>$txt</i>
is a suitable email address.
<p class="indent">
<b>-u</b>
Update the firewall tables and firewall configuration file to synchronise
the administration server with the target host only. 
<b>chkfw</b>
will compare the output of 
<b>"iptables -nL"</b>
with a template kept on the administration server and if they differ will
archive the existing template and update the template with a copy of the output
from the target host. The firewall configuration file will similarly be updated.
This is to facilitate making changes on the target host and then synchronising 
the records on the administration server.
<b>NB</b>
The source file for reconfiguring the target host iptables is not at present
changed by using 
<b>-u</b>
option.
<p class="indent">
<b>-U</b>
With the
<b>-U</b>
option the source firewall boot file will be updated from the remote firewall boot
file (<i>/etc/sysconfig/iptables</i> by default) in addition to the template and configuration
file as with the 
<b>-u</b>
option above. It is an error to combine 
<b>-u</b>
and 
<b>-U</b>
on the command line. 
<p class="indent">
<b>-v</b>
Set verbose mode. Ordinarily 
<b>chkfw</b>
operates silently unless problems are detected. In 
<i>verbose</i>
mode 
<b>chkfw</b>
reports on each significant action.
<p class="indent">
<b>-V</b>
Print version details and exit.
<h2 id="heading6">EXAMPLES</h2>
.IP
.ft CW
chkfw -m 30 -p 21,22 -v hostname
.ft R
<p>
Check the running 
<b>iptables </b>
firewall on 
.IR hostname .
Use 
<b>nmap</b>
to ensure that the ports 21 and 22 are open. Run in verbose mode.
<h2 id="heading7">FILES</h2>
.IR <hostname>:/etc/sysconfig/iptables ,
.IR <hostname>:/etc/sysconfig/iptables-config
.IR /usr/local/etc/<hostname>.d/fw .

<h2 id="heading8">BUGS</h2>
The script is quite crude having been developed to address problems experienced
by City Linux clients running on CentOS servers at 1and1. It does depend on
very specific file and remote access permissions. Particularly it expects that
where root permission is required 
<b>sudo</b>
will be used. With judicious use of the 
<i>debug</i>
and
<i>verbose </i>
modes, permission and configuration problems should be relatively easy to 
resolve.
<p>
The check on ftp transfer rates has been recently removed.
<h2 id="heading9">SEE ALSO</h2>
.IR chkdf ,
.IR chkftpd ,
.IR chkmail ,
.IR chkup ,
.IR clean ,
.IR secscan .
.SH AUTHOR
Clifford W Fulford, City Linux. Contact fulford@fulford.net or +44 (0)709 229 5385.
.SH HISTORY
$Id: chkfw.man,v 1.56 2016/02/17 17:25:22 fulford Exp fulford $
